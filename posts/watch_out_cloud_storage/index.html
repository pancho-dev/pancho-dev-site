<!DOCTYPE html>
<html lang="en-us">

<head><title>
    Watch Out With Cloud Storage API Calls!!! | 
    
    pancho.dev</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="description" content="One of the most popular services from cloud providers is cloud storage, to be more specific AWS S3, Google Cloud Storage, Azure Storage or any similar service from other cloud providers. This service is very convenient for developers and SREs or System Admins, it solves the problem of managing disks, storage devices , storage servers, etc at a very low cost for storing files, depending on the cloud provider, some of them even offer a staggering 99.
    ">


<meta property="og:title" content="Watch out with cloud storage API calls!!!" />
<meta property="og:description" content="One of the most popular services from cloud providers is cloud storage, to be more specific AWS S3, Google Cloud Storage, Azure Storage or any similar service from other cloud providers. This service is very convenient for developers and SREs or System Admins, it solves the problem of managing disks, storage devices , storage servers, etc at a very low cost for storing files, depending on the cloud provider, some of them even offer a staggering 99." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://pancho.dev/posts/watch_out_cloud_storage/" />
<meta property="article:published_time" content="2020-10-24T11:30:35-03:00" />
<meta property="article:modified_time" content="2020-10-24T11:30:35-03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Watch out with cloud storage API calls!!!"/>
<meta name="twitter:description" content="One of the most popular services from cloud providers is cloud storage, to be more specific AWS S3, Google Cloud Storage, Azure Storage or any similar service from other cloud providers. This service is very convenient for developers and SREs or System Admins, it solves the problem of managing disks, storage devices , storage servers, etc at a very low cost for storing files, depending on the cloud provider, some of them even offer a staggering 99."/>

<meta itemprop="name" content="Watch out with cloud storage API calls!!!">
<meta itemprop="description" content="One of the most popular services from cloud providers is cloud storage, to be more specific AWS S3, Google Cloud Storage, Azure Storage or any similar service from other cloud providers. This service is very convenient for developers and SREs or System Admins, it solves the problem of managing disks, storage devices , storage servers, etc at a very low cost for storing files, depending on the cloud provider, some of them even offer a staggering 99.">
<meta itemprop="datePublished" content="2020-10-24T11:30:35-03:00" />
<meta itemprop="dateModified" content="2020-10-24T11:30:35-03:00" />
<meta itemprop="wordCount" content="707">



<meta itemprop="keywords" content="AWS,cloud provider,cloud storage," />
<link rel="canonical" href="http://pancho.dev/posts/watch_out_cloud_storage/" />

<link rel="icon" type="image/png" href="http://pancho.dev/image/favicon.ico">

<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/bulma.min.css">



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-920705-12', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script src=/js/ramium.js></script>
<link rel="stylesheet" href=/css/ramium.css>





</head>

<body><nav class="navbar is-dark" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href=/>
      
      <strong>pancho.dev </strong>
      
    </a>

    <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false"
      data-target="navbarBasicExample">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="navbarBasicExample" class="navbar-menu">
    <div class="navbar-start">
      
      
      <a class="navbar-item" href="/">Home</a>
      
      
      
      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">Blog</a>
        <div class="navbar-dropdown">
          
          <a class="navbar-item" href="/posts/">All Posts</a>
          
        </div>
      </div>
      
      
    </div>

    <div class="navbar-end">
      

      
    </div>
  </div>
</nav><div class="columns is-centered">
        <div id="page-body" class="column is-7">

<div class="content blog">
    <h1>Watch Out With Cloud Storage API Calls!!!</h1>

    <div id="infobar" class="level is-mobile">
        <div class="level-left">
            
            <div class="level-item">
                <p class="subtitle info date">Oct 24, 2020
                </p>
            </div>
            

            <div class="level-item">
                <p class="subtitle info">
                    4 mins read
                </p>
            </div>
        </div>
        <div class="level-right is-hidden-touch">
            <div class="tags">
                
                <a class="tag is-dark is-rounded" href="/tags/aws">AWS</a>
                
                <a class="tag is-dark is-rounded" href="/tags/cloud-provider">Cloud Provider</a>
                
                <a class="tag is-dark is-rounded" href="/tags/cloud-storage">Cloud Storage</a>
                
            </div>
        </div>
    </div>

    <div class="tags is-hidden-desktop">
        
        <a class="tag is-dark is-rounded" href="/tags/aws">A w s</a>
        
        <a class="tag is-dark is-rounded" href="/tags/cloud-provider">Cloud provider</a>
        
        <a class="tag is-dark is-rounded" href="/tags/cloud-storage">Cloud storage</a>
        
    </div>

    <div class="blog-text">
        

        <p>One of the most popular services from cloud providers is cloud storage, to be more specific AWS S3, Google Cloud Storage, Azure Storage or any similar service from other cloud providers. This service is very convenient for developers and SREs or System Admins, it solves the problem of managing disks, storage devices , storage servers, etc at a very low cost for storing files, depending on the cloud provider, some of them even offer a staggering 99.999999999% durability. Given the benefits and low cost of such services, I have seen more and more reliance on the cloud storage services.<br>
But there is a catch on the cheap pricing, in order to make a good decision when architecting an application we need to look a all pricing items for the cloud storage service to optimize around costs.  Cloud storage services usually charge for the storage used for files stored, api calls to put, retrieve and list files and network traffic. So we need to have in mind this parameters to avoid surprises on our cloud storage bills. I will not go into too much details on each cloud provider on this post but I will show something I found out recently that made an application lower the costs about 10 times just by optimizing the way the data was being accessed. This optimizations might be a key to make a feature or an app profitable.<br>
In particular I will talk about AWS S3 api calls and the behavior of some of the official AWS SDKs that needed some tweaking. Off course all findings shown in this post were done with documentation found at the time of this writing. So I suggest double check the SDKs behavior as it might change in the future.</p>
<h1 id="aws-s3-multipart-uploads">AWS S3 Multipart Uploads</h1>
<p>A restriction on the AWS Rest APIs is that there is a limit to PUT requests of 5GB, which means when we are working with S3 API and want to upload files bigger than 5GB.<br>
For managing that restriction and be able to upload files bigger than 5GB S3 API implements the Multipart uploads, which allows you to upload a file into chunks.<br>
This approach brings a lot of benefits because it allows to upload chunks in parallel or handle failures gracefully and only re upload failed chunks making recovery much faster when uploading big files, etc; there could be many benefits using multipart uploads.<br>
But there is a hidden cost, when you upload a file using multipart upload there are inherently more API calls associated with uploading 1 file. At least one initiateMultiPartUpload plus an uploadPart per chunk, and depending the size and the amount of chunks api calls can increase significantly for example if we have a chunk size of 10MB and we upload a file of 1GB this will turn into ~100 api calls, while the cost per 100 api calls is low, when you are uploading thousands of files this makes a huge difference.<br>
Off course probably very few people uses the AWS API directly and use AWS official SDKs which abstract many of this details for us, I suggest to check the defaults for S3 uploads for the chosen SDK in order to avoid surprises.</p>
<h1 id="aws-go-sdk">AWS go SDK</h1>
<p>To my surprise I had a Go application that was uploading files to S3 and one day I noticed the S3 bill was increasing every month, so first I didn&rsquo;t know what was it so ended up setting up tags on S3 buckets to be able to filter by each bucket in the AWS cost explorer. Then found out that I was paying very little for storage per day in this application and I was paying 10 to 12 times more on API calls</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// MaxUploadParts is the maximum allowed number of parts in a multi-part upload
</span><span style="color:#75715e">// on Amazon S3.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MaxUploadParts</span> = <span style="color:#ae81ff">10000</span>

<span style="color:#75715e">// MinUploadPartSize is the minimum allowed part size when uploading a part to
</span><span style="color:#75715e">// Amazon S3.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MinUploadPartSize</span> <span style="color:#66d9ef">int64</span> = <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>

<span style="color:#75715e">// DefaultUploadPartSize is the default part size to buffer chunks of a
</span><span style="color:#75715e">// payload into.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DefaultUploadPartSize</span> = <span style="color:#a6e22e">MinUploadPartSize</span>

<span style="color:#75715e">// DefaultUploadConcurrency is the default number of goroutines to spin up when
</span><span style="color:#75715e">// using Upload().
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">DefaultUploadConcurrency</span> = <span style="color:#ae81ff">5</span></code></pre></div>

    </div>
</div><div id="social-media-share" class="has-text-centered">
	<p><i>Sharing is caring!</i></p>
	<br>
	
	<div class="share-buttons">
	    <a  href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        onclick="socialMediaPopUp(this.href, '', 500, 500); return false;"
	        title="Share on Facebook. Opens in a new window.">
	        <img src=/img/icons/45px/facebook.png>
	    </a>

	    <a  href="https://twitter.com/intent/tweet?text=Watch%20out%20with%20cloud%20storage%20API%20calls%21%21%21&url=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        onclick="socialMediaPopUp(this.href, '', 500, 500); return false;"
	        title="Share on Twitter. Opens in a new window." >
	        <img src=/img/icons/45px/twitter.png>
	    </a>

		<a  href="http://www.reddit.com/submit?url=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Reddit. Opens in a new window." >
	        <img src=/img/icons/45px/reddit.png>
	    </a>

	    <a  href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Pinterest. Opens in a new window." >
	        <img src=/img/icons/45px/pinterest.png>
	    </a>

	    <a  href="http://www.tumblr.com/share/link?url=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on Tumblr. Opens in a new window." >
	        <img src=/img/icons/45px/tumblr.png>
	    </a>

		<a  href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f
			&title=Watch%20out%20with%20cloud%20storage%20API%20calls%21%21%21&summary=One%20of%20the%20most%20popular%20services%20from%20cloud%20providers%20is%20cloud%20storage%2c%20to%20be%20more%20specific%20AWS%20S3%2c%20Google%20Cloud%20Storage%2c%20Azure%20Storage%20or%20any%20similar%20service%20from%20other%20cloud%20providers.%20This%20service%20is%20very%20convenient%20for%20developers%20and%20SREs%20or%20System%20Admins%2c%20it%20solves%20the%20problem%20of%20managing%20disks%2c%20storage%20devices%20%2c%20storage%20servers%2c%20etc%20at%20a%20very%20low%20cost%20for%20storing%20files%2c%20depending%20on%20the%20cloud%20provider%2c%20some%20of%20them%20even%20offer%20a%20staggering%2099.&source=rafed123.github.io"
	        onclick="socialMediaPopUp(this.href, '', 900, 500); return false;"
	        title="Share on LinkedIn. Opens in a new window." >
	        <img src=/img/icons/45px/linkedin.png>
	    </a>

	    <a  href="mailto:?subject=Watch%20out%20with%20cloud%20storage%20API%20calls%21%21%21&amp;body=Check out this site http%3a%2f%2fpancho.dev%2fposts%2fwatch_out_cloud_storage%2f"
	        title="Share via Email. Opens in a new window." >
	        <img src=/img/icons/45px/mail.png>
	    </a>
	</div>
</div>


<br>
<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = '';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        </div>
    </div>

<footer class="footer has-background-dark">
    <div class="content has-text-centered has-text-white">
        <p>
            Â© 2020 Ramium. Powered by
            <a class="has-text-light" href="https://github.com/gohugoio/hugo" target="_blank">
            Hugo</a>. Theme
            <a class="has-text-light" href="https://github.com/rafed123/ramium/" target="_blank">
                Ramium.
            </a>
        </p>
    </div>
</footer>
</body>

</html>